<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>List messages</title>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css">
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</head>
<body>
<div id="app">
    <header class="header">
        <h1 class="logo"><span style="color: rgba(255,181,60,0.9)">TestCode</span></h1>
    </header>
    <main>
        <div class="settings">
            <h6>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</h6>
            <label>
                Api URL:
                <input type="text" v-model="apiURL">
            </label>
            <div>
                –ù–∞ –∫–∞–∫–æ–º —è–∑—ã–∫–µ –±–µ–∫–µ–Ω–¥?
                <button @click="backendLanguage='JS'" v-bind:class="{'selected': backendLanguage === 'JS'}">JS
                </button>
            </div>
            <div>
                –í–µ—Ä—Å–∏—è –ê–ü–ò
                <button @click="apiVersion='v1'" :class="{'selected': apiVersion === 'v1'}">v1</button>
            </div>
            <div>
                <button @click="getTasks()" class="primary">–ü–æ–µ—Ö–∞–ª–∏</button>
            </div>
        </div>
        <div class="wrapper login" v-if="step === 'login'">
            <h5>–î–æ—Å—Ç—É–ø –∫ —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏</h5>
            <div class="LoginInput">
                <input v-model.lazy="login" :class="emailValid ? 'validate':'validate invalid'" type="email"
                       :placeholder="eplaceHolder" autofocus required>
                <span class="errorMsg" v-if="!this.emailValid">Incorrect format E-mail</span>
                <input v-model.lazy="pass" class="validate" type="password" placeholder="******" required minlength="6"
                       maxlength="20">
                <span class="errorMsg pass" v-if="!this.passValid">Password length min 6</span>
                <input v-model.lazy="userName" class="validate" type="text" placeholder="user name" autocomplete="on"
                       required>
                <span class="errorMsg user-name" v-if="!this.userNameValid">User name length min 1</span>
                <input v-model="homePage" type="url" placeholder="homePage" autocomplete="on">
            </div>
            <div class="LoginButton">
                <button @click="register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button @click="logIn" class="primary">–í–æ–π—Ç–∏</button>
            </div>
        </div>
        <div class="wrapper" v-else-if="step === 'items'">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å:</h3>
            <div v-if="posting">
                <label style="display: flex;">
                    <input @keyup.enter="addTask" class="new_todo" autofocus autocomplete="off"
                           placeholder="Create new post"
                           type="text" v-model="new_task.text">
                    <span><button @click="addTask" @keypress.enter="addTask"
                                  class="button new_todo_button">–ü–æ—Å—Ç–∏—Ç—å</button></span>
                </label>
            </div>
            <div v-else>
                <label style="display: flex;">
                    <input @keyup.enter="addCommit" class="new_todo" value=""
                           placeholder="Create comment for checked post"
                           type="text" v-model="new_comit.text">
                    <span><button @click="addCommit" @keypress.enter="addCommit" class="button new_todo_button">–ö–æ–º–µ–Ω—Ç–∏—Ç—å</button></span>
                </label>
            </div>

            <h3 class="status_title">{{ '–í—Å–µ –∑–∞–ø–∏—Å–∏: ' + tasks.length }}</h3>
            <task @task_del="deleteTask(task.id)"
                  @task_edit="editTask(index)"
                  @task_done="markForCommit(index,task)"
                  @save="save(index, task.id)"
                  @disable="disable(index)"
                  @get_my_tasks="getOnlyMyTasks()"
                  :data="task"
                  v-bind:index="index+1"
                  v-for="(task, index) in tasks"
                  :login="currentLogin"
                  :key="index"></task>

            <div class="wrapper pagination" v-if="pages > 1">
                <button @click="getTasks(idx)" v-for="idx in pages" class="each-page">{{ idx }}</button>
            </div>

            <hr>
            <button @click="logout" class="logout btn btm-small js-remove">–í—ã–π—Ç–∏ &#128682;</button>
        </div>
        <div class="wrapper" v-else-if="step === 'error'">
            –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ —á—Ç–æ–± —É–≤–∏–¥–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏.
        </div>
    </main>
</div>
<script>
    Vue.component("task", {
        props: ["data", "index", "login"],
        template: `
          <div class="task" v-bind:class="{ taskCompleted: data.checked}">
          <div class="contentText">
            <div>
              <button @click="$emit('task_done')" class="task_done taskButton">
                <span v-if="!data.checked" style="color: rgba(0,0,0,.28);"> ‚òê </span>
                <span v-else style="color: rgba(255,181,60,0.9)"> ‚òë </span>
              </button>
              <a class="task_face">{{ String.fromCodePoint(data.face) }}</a>
              <span class="task_head">
                   <strong>{{ data.userName }}</strong> {{ data.createdAt }}
                </span>
            </div>
            <div v-if="login == data.login">
              <div class="button check" v-if="!data.editable">
                <button @click="$emit('task_edit')" style="color: #eca81a;"> ‚úéÔ∏è</button>
                <button @click="$emit('task_del')" style="color: #cd1537;"> ‚úï</button>
                <button v-if="data.userName" @click="$emit('get_my_tasks')" style="color: #15cd2e;">üîé</button>
              </div>
              <div v-else>
                <button @click="$emit('save')"> üíæ</button>
                <button @click="$emit('disable')"> ‚úï</button>
              </div>
            </div>
          </div>
          <div class="task_content" v-if="!data.editable">
            {{ data.text }}
          </div>
          <div v-else>
            {{ index }}.<input @keyup.enter="$emit('save')" v-model="data.inputedit" autofocus
                               class="edit-input"/>
          </div>
          </div>
        `
    });

    let vue = new Vue({
        el: '#app',
        data: {
            new_task: {
                text: '',
                editable: false,
                checked: false
            },
            new_comit: {
                text: '',
                editable: false,
            },
            tasks: [],
            login: '',
            userName: '',
            face: '',
            pages: '',
            currentLogin: '',
            homePage: '',
            _csrf: '',
            pass: '',
            backendLanguage: 'JS',
            apiURL: 'http://localhost:3001/api/',
            apiVersion: 'v1',
            step: '',
            posting: true,
            checkedTask: '',
            eplaceHolder: 'yaropolk@example.com',
            emailValid: true,
            userNameValid: true,
            passValid: true,
        },

        computed: {
            /*isEmailValid() {
                return this.emailValid;
            },*/
        },
        watch: {
            login(value) {
                this.emailValid = /\w+@/.test(value);
            },
            pass(value) {
                this.passValid = value.length > 6 && value.length < 20;
            },
            userName(value) {
                this.userNameValid = value.length > 0;
            },
        },
        methods: {
            getOnlyMyTasks: function () {
                const route = this.apiVersion === 'v1' ? '/items' : '/router';
                const qs = {action: this.apiVersion === 'v1' ? '' : 'getItems'};

                fetch(this.apiURL + this.apiVersion + route + '/my' + '?' + new URLSearchParams(qs), {
                    credentials: 'include',
                    method: this.apiVersion === 'v1' ? 'GET' : 'POST',
                })
                    .then(res => res.json())
                    .then((response) => {
                        if (response.error === 'forbidden') {
                            this.step = 'login';
                        } else {
                            this.tasks = response.items.sort(function (oneCommit, secCommit) {
                                return Date.parse(secCommit.createdAt) - Date.parse(oneCommit.createdAt);
                            });
                            this.tasks = this.tasks.map((item) => {
                                item.editable = false;
                                item.createdAt = Intl.DateTimeFormat('ru-RU', {
                                    day: '2-digit',
                                    month: 'long',
                                    year: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                }).format(new Date(item.createdAt));
                                return item;
                            });
                            this.step = 'items';
                        }
                    }).catch((error) => {
                    this.step = 'error';
                })
            },
            getTasks: function (numberPage = 1) {
                const route = this.apiVersion === 'v1' ? '/items' : '/router';
                const qs = {action: this.apiVersion === 'v1' ? numberPage : 'getItems'};
                /*http://localhost:3001/api/v1/items?action=1*/
                fetch(this.apiURL + this.apiVersion + route + '?' + new URLSearchParams(qs), {
                    credentials: 'include',
                    method: this.apiVersion === 'v1' ? 'GET' : 'POST',
                })
                    .then(res => res.json())
                    .then((response) => {
                        if (response.error === 'forbidden') {
                            this.step = 'login';
                        } else {
                            this._csrf = response['_csrf'];
                            this.pages = parseInt(response['amountPage']) || 0;
                            this.currentLogin = response['loginOfCurrentUser'];
                            /*sorting*/
                            this.tasks = response.items.sort(function (oneCommit, secCommit) {
                                return Date.parse(secCommit.createdAt) - Date.parse(oneCommit.createdAt);
                            });
                            /*formatting time*/
                            this.tasks = this.tasks.map((item) => {
                                item.editable = false;
                                item.createdAt = Intl.DateTimeFormat('ru-RU', {
                                    day: '2-digit',
                                    month: 'long',
                                    year: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                }).format(new Date(item.createdAt));
                                return item;
                            });

                            this.step = 'items';
                        }
                    }).catch((error) => {
                    this.step = 'error';
                })
            },
            deleteTask: function (index) {
                let request = JSON.stringify({id: index,});
                const route = this.apiVersion === 'v1' ? '/items' : '/router';
                const qs = {action: this.apiVersion === 'v1' ? '' : 'deleteItem'};
                fetch(this.apiURL + this.apiVersion + route + '?' + new URLSearchParams(qs), {
                    method: this.apiVersion === 'v1' ? 'DELETE' : 'POST',
                    body: request,
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                }).then(res => res.json())
                    .then((response) => {
                        if (response['ok'] === true) {
                            this.getTasks()
                        } else {
                            alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ —á—Ç–æ–± —É–≤–∏–¥–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏.")
                        }
                    });
            },
            addTask: function () {
                if (this.new_task.text.trim() !== '') {
                    let request = JSON.stringify({text: this.new_task.text, _csrf: this._csrf});
                    const route = this.apiVersion === 'v1' ? '/items' : '/router';
                    const qs = {action: this.apiVersion === 'v1' ? '' : 'createItem'};
                    fetch(this.apiURL + this.apiVersion + route + '?' + new URLSearchParams(qs), {
                        method: this.apiVersion === 'v1' ? 'POST' : 'POST',
                        body: request,
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    }).then(res => res.json())
                        .then((response) => {
                            if (response.id) {
                                this.getTasks();
                                this.$set(this.new_task, 'text', '');
                            } else {
                                alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ —á—Ç–æ–± —É–≤–∏–¥–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏.")
                            }
                        });
                }
            },

            addCommit: function () {
                console.log('uuid-', this.checkedTask.uuid);
                if (this.new_comit.text.trim() !== '') {
                    let request = JSON.stringify({
                        text: this.new_comit.text,
                        parentUuid: this.checkedTask.uuid,
                        _csrf: this._csrf
                    });
                    const route = this.apiVersion === 'v1' ? '/items' : '/router';
                    const qs = {action: this.apiVersion === 'v1' ? '' : 'editItem'};
                    fetch(this.apiURL + this.apiVersion + route + '/commit' + '?' + new URLSearchParams(qs), {
                        method: this.apiVersion === 'v1' ? 'POST' : 'POST',
                        body: request,
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    })
                        .then(res => res.json())
                        .then(() => {
                            this.posting = true;
                            this.getTasks()
                        });
                }
            },
            updateTask: function (index, id) {
                let request = JSON.stringify({
                    text: this.tasks[index].text,
                    id: id,
                    checked: this.tasks[index].checked,
                    _csrf: this._csrf
                });
                /*{"text":"Djon!!!","id":1,"checked":true}*/
                const route = this.apiVersion === 'v1' ? '/items' : '/router';
                const qs = {action: this.apiVersion === 'v1' ? '' : 'editItem'};
                fetch(this.apiURL + this.apiVersion + route + '?' + new URLSearchParams(qs), {
                    method: this.apiVersion === 'v1' ? 'PUT' : 'POST',
                    body: request,
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                })
                    .then(res => res.json())
                    .then(() => {
                        this.getTasks()
                    });
            },
            markForCommit(index, task) {
                console.log('!index-', index);
                console.log('!task-', task);
                this.$set(this.tasks[index], 'checked', !this.tasks[index].checked);
                this.posting = !this.posting;
                this.checkedTask = task;
            },
            editTask(index) {
                this.$set(this.tasks[index], 'editable', true);
                this.$set(this.tasks[index], 'inputedit', this.tasks[index].text);
            },
            save(index, id) {
                if (this.new_task.text !== '' || this.new_task.text !== ' ') {
                    this.$set(this.tasks[index], 'text', this.tasks[index].inputedit);
                    this.updateTask(index, id);
                    this.$set(this.tasks[index], 'editable', false);

                }
            },
            disable(index) {
                this.$set(this.tasks[index], 'editable', false);
                this.$set(this.tasks[index], 'inputedit', '');
            },
            logout() {
                const route = this.apiVersion === 'v1' ? '/logout' : '/router';
                fetch(this.apiURL + this.apiVersion + route, {
                    method: this.apiVersion === 'v1' ? 'POST' : 'POST',
                    credentials: 'include',
                }).then(res => res.json())
                    .then((response) => {
                        if (response.ok) {
                            localStorage.clear();
                            this.step = 'login';
                        }
                    });
            },
            logIn() {
                if (this.login.trim() !== '' && this.pass.trim()) {
                    let params = JSON.stringify({login: this.login, pass: this.pass});
                    const route = this.apiVersion === 'v1' ? '/login' : '/router';
                    const qs = {action: this.apiVersion === 'v1' ? '' : 'login'};
                    fetch(this.apiURL + this.apiVersion + route + '?' + new URLSearchParams(qs), {
                        method: this.apiVersion === 'v1' ? 'POST' : 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: params
                    })
                        .then(res => res.json())
                        .then(response => {
                            if (response.ok) {
                                this._csrf = response['_csrf'];
                                localStorage.setItem('name', this.login);
                                this.getTasks();
                                this.step = 'items';
                            } else if (response.error === 'not found') {
                                alert('–¢–∞–∫–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –ª–æ–≥–∏–Ω–∞ –∏ –ø–∞—Ä–æ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                            } else {
                                alert(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. ${response.errors[0].msg}.`)
                            }
                        })
                }
            },
            register() {
                if (this.login.trim() !== '' && this.pass.trim() && this.userName.trim() !== '') {
                    let params = JSON.stringify({
                        login: this.login,
                        pass: this.pass,
                        userName: this.userName,
                        homePage: this.homePage,
                    });
                    const route = this.apiVersion === 'v1' ? '/register' : '/router';
                    const qs = {action: this.apiVersion === 'v1' ? '' : 'register'};
                    fetch(this.apiURL + this.apiVersion + route + '?' + new URLSearchParams(qs), {
                        method: this.apiVersion === 'v1' ? 'POST' : 'POST',
                        body: params,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    })
                        .then(res => res.json())
                        .then((response) => {
                            if (response.ok) {
                                this.logIn();
                            } else {
                                alert(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. ${response.errors[0].msg}.`)
                            }
                        });
                }
            },
        },
    });
</script>
</body>
</html>